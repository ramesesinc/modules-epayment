<%
	if(!PARAMS.receiptno && !PARAMS.refno )
		throw new Exception("Please provide a receiptno or refno parameter");

	def receiptno = PARAMS.receiptno;
	def agency = PARAMS.info;
		

	//this should be applicable both with partner or without partner
	def partnerid = PARAMS.info?.id;

	if(partnerid == null) {
		//this is called from the global context
		def svc = SERVICE.lookup("CloudPaymentService", "epayment");
		def p =[:];
		if(PARAMS.receiptno) p.receiptno = PARAMS.receiptno;
		else if(PARAMS.refno) p.refno = PARAMS.refno;

		def rct = svc.getReceiptInfo( p );
		partnerid = rct.partnerid;
		receiptno = rct.receiptno;

		def partnerSvc = SERVICE.lookup("CloudPartnerService", "partner");
    	agency = partnerSvc.findById( [id: partnerid] ); 
	}
	else {
		//this is called if under the partners context
		if(PARAMS.refno) {
			def svc = SERVICE.lookup("CloudPaymentService", "epayment");
			def rct = svc.getReceiptInfo( [refno: PARAMS.refno ] );
			receiptno = rct.receiptno;
		}
	}

	if(!receiptno) 
		throw new Exception("Receiptno is not provided or does not exist");

%>

<script>
\$register( {id:'eor51', context: 'eor51', page:"/epayment/receipttemplates/eor51" } );
\$register( {id:'eor56', context: 'eor56', page:"/epayment/receipttemplates/eor56" } );

\$put("eor", new function() {
	var self = this;
	this.error;
	this.receipt;
	this.agency = { title: '${agency.title}', group: {title:'${agency.group.title}' } };

	this.loadReceipt = function( handler ) {
		var svc = Service.lookup("${partnerid}:EPaymentService");
		svc.getReceipt( {receiptno: "${receiptno}"}, function(s,o) {
			if( s.status =="ERROR") {
				self.error = "Receipt does not exist";
			}
			else {
				self.error = null;
				self.receipt = o.result;
				console.log( self.receipt );
				handler(self.receipt);
			}
		});
	};

	this.onload = function() {
		this.loadReceipt( function(rct) {
			if(!rct.formno) rct.formno = '51';
			window.location.hash = "eor"+rct.formno;
		});
	};

});
</script>

<div r:context="eor" r:visibleWhen="#{error!=null}" style="display:none;">
	<label r:context="eor">#{error}</label>
</div>

<div id="content"></div>
