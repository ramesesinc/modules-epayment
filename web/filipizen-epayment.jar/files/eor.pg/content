<%
	if(!PARAMS.receiptno && !PARAMS.refno )
		throw new Exception("Please provide a receiptno or refno parameter");

	def receiptno = PARAMS.receiptno;
	def agency = PARAMS.info;
		

	//this should be applicable both with partner or without partner
	def partnerid = PARAMS.info?.id;

	if(partnerid == null) {
		//this is called from the global context
		def svc = SERVICE.lookup("CloudPaymentService", "epayment");
		def p =[:];
		if(PARAMS.receiptno) p.receiptno = PARAMS.receiptno;
		else if(PARAMS.refno) p.refno = PARAMS.refno;

		def rct = svc.getReceiptInfo( p );
		partnerid = rct.partnerid;
		receiptno = rct.receiptno;

		def partnerSvc = SERVICE.lookup("CloudPartnerService", "partner");
    	agency = partnerSvc.findById( [id: partnerid] ); 
	}
	else {
		//this is called if under the partners context
		if(PARAMS.refno) {
			def svc = SERVICE.lookup("CloudPaymentService", "epayment");
			def rct = svc.getReceiptInfo( [refno: PARAMS.refno ] );
			receiptno = rct.receiptno;
		}
	}

	if(!receiptno) 
		throw new Exception("Receiptno is not provided or does not exist");

%>

<script>
\$put("eor", new function() {
	var self = this;
	this.error;
	this.receipt;

	this.onload = function() {
		var svc = Service.lookup("${partnerid}:EPaymentService");
		svc.getReceipt( {receiptno: "${receiptno}"}, function(o,s) {
			if( s=="error") {
				self.error = "Receipt does not exist";
			}
			else {
				self.error = null;
				self.receipt = o.result;
			}
			self._controller.refresh();
		})
	}

});
</script>

<div r:context="eor" r:visibleWhen="#{error!=null}" style="display:none;">
	<label r:context="eor">#{error}</label>
</div>

<div r:context="eor" r:visibleWhen="#{error==null}" style="display:none;">
	<div style="margin-left:200px;margin-right:200px;margin-top:50px;border:1px solid lightgrey;padding-top:20px;">
		<div class="col-md-12">
		    <div class="row">
		        <div class="receiptinfo col-md-7">
		            EOR No.: 
		            <h1 class="eorno"><label r:context="eor">#{receipt.receiptno}</label></h1>
		            <strong>Paid By : </strong> <label r:context="eor">#{receipt.paidby}</label><br />
		            <strong>Address: </strong><label r:context="eor">#{receipt.paidbyaddress}</label><br />
		            <strong>Particulars: </strong> <label r:context="eor">#{receipt.remarks}</label><br />
		            <strong>Agency: </strong> <label r:context="eor">${agency.title}, ${agency.group.title}</label>
		        </div>
		        <div class="qrdata col-md-5">
		        	<img id='qrcode' src="https://api.qrserver.com/v1/create-qr-code/?data=${PARAMS.receiptno}&amp;size=250x250" width="150" height="150" class="img-responsive"/>					
		            <div id="output"></div>
		        </div>
		    </div>
		    <hr>
		    <div class="row">
		        <div class="col-lg-6 col-md-6 col-sm-6">
		            <strong>PAYMENT DETAILS :</strong>
		        </div>
		    </div>
		    <hr>
		    <div class="row">
		        <div class="col-lg-12 col-md-12 col-sm-12">
		            <div class="table-responsive">
		                <table class="table table-bordered" r:context="eor" r:items="receipt.items" r:varName="item">
		                    <thead>
			                    <tr>
			                        <th class="text-left" style="padding-left:15px;">Account</th>
			                        <th class="text-right" style="padding-right:15px;" maxWidth="100">Amount</th>
			                    </tr>
		                    </thead>
		                    <tbody>
			                    <tr> 
			                        <td class="text-left" style="padding-left:15px;"> #{item.item.title} #{item.remarks}</td> 
			                        <td class="text-right" style="padding-right:15px;"> #{ item.amount.formatDecimal() } </td> 
			                    </tr> 
		                    </tbody>
		                </table>
		            </div>
		            
		            <hr>
		            <div>
		                <h4>  TOTAL : Php  <label r:context="eor">#{ receipt.amount.formatDecimal() }</label></h4>
		            </div>

		            <hr>
		            <div>
		                <h4>  Amount in words : <label r:context="eor">#{receipt.amountinwords}</label> </h4>
		            </div>

		            <hr>
		        </div>
		    </div>

		    <div class="row">
		        <div class="col-lg-12 col-md-12 col-sm-12">
		            <strong>Bank : </strong>  <label r:context="eor">#{receipt.partner.name}</label>
		            <br />
		            <strong>Txn No.: </strong> <label r:context="eor">#{receipt.traceid}</label> 
		            <br />
		            <strong>Txn Date: </strong> <label r:context="eor">#{receipt.tracedate}</label>
		        </div>
		    </div>
		    <hr>
		    
		</div>
	</div>
	<div style="margin:30px 0px 0px 200px">
		<div class="row">
	        <div class="col-lg-12 col-md-12 col-sm-12">
	            <button onclick="location.href='javascript:window.print()';" href="" class="btn btn-primary btn-sm btn-eor" >Print EOR</button> &nbsp; &nbsp; &nbsp;
	            <!-- <button id="export" class="btn btn-info btn-sm btn-eor">Download In Pdf</button> -->
	        </div>
	    </div>
    </div>
    <hr class="hr-bottom">
</div>

<style>
	@media print {
         .navbar-inverse{display:none}
         .footer{display:none}
         #Header, #Footer { display: none ! important; }
         @page {size: auto;margin: 0mm;}
      }
</style>