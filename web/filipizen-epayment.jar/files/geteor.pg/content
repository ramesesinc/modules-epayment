<%
def m = [:]; 
boolean pass = false;
try {
	def paymentrefid = REQUEST.queryString.toString().split('&')[0]; 
	def svc = SERVICE.lookup( "FilipizenPaymentService" ); 
	if ( svc == null ) throw new Exception('FilipizenPaymentService not found');

	def data = svc.verifyPayment([ paymentrefid: paymentrefid, silent: true ]); 
	if ( data == null ) throw new Exception('Payment transaction not found'); 

	if ( data.receiptno == null ) { 
		m.errmsg ='EOR Receipt is still pending at this time. You will be notified as soon as the receipt is posted.';

	} else {
		m.receiptno = data.receiptno; 
		pass = true; 
	}
}
catch(Throwable t) {
	def errmsg = t.message; 
	if ( !errmsg ) {
		def cause = t.cause; 
		while ( cause != null ) {
			errmsg = cause.message; 
			if ( errmsg ) break; 
		}
	}	

	m.errmsg = errmsg.toString(); 
    t.printStackTrace();
}
%>

<% if (!pass) {%>
<pre style="margin:10px;">${m.errmsg.toString()}</pre>

<% } else { %> 

<script>
window.location.href = "/receipt?${m.receiptno}";
</script>

<% } %> 