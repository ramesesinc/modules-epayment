<%
def m = [:]; 
boolean pass = false;
try {
  def svc = SERVICE.lookup( "FilipizenPaymentService" ); 
  if ( svc == null ) throw new Exception('FilipizenPaymentService not found');

  m = [ amount: 0.00, webfee: 0.00, options: []]; 

  def paymentrefid = PARAMS.paymentrefid; 
  def po = svc.verifyPaymentOrder([ paymentrefid : paymentrefid ]); 
  if ( po ) { 
    m = [txntype: po.txntype, orgcode: po.orgcode, refno: po.refno, po: po]; 
    m.options = svc.getPaymentMethods( m ); 
    m.amount = po.amount; 

    def pinfo = svc.findPartnerInfo([ partnerid: po.orgcode ]);     
    m.webfee = (pinfo?.webfee ? pinfo.webfee : 0.00); 

    svc.updatePaymentOrder([paymentrefid: paymentrefid], [webfee: m.webfee]);  
  } 

  m.paymentrefid = paymentrefid;
  m.total = m.amount + m.webfee; 
  
  def numformat = new java.text.DecimalFormat('#,##0.00'); 
  m.totalstr = numformat.format( m.total );  
  m.webfeestr = numformat.format( m.webfee );  
  m.amountstr = numformat.format( m.amount );    

  m.expirydatestr = null; 
  if ( po?.expirydate instanceof java.util.Date ) {
    m.expirydatestr = new java.text.SimpleDateFormat("MMM dd, yyyy").format( po.expirydate ).toUpperCase(); 
  } 

  m.options.each{ 
    it.objid = it.objid.toString().toLowerCase(); 
    if ( !it.icon ) it.icon = it.objid +'/icon.png'; 
    it.formname = it.objid + 'form'; 
    it.formaction = it.info?.actionurl; 
    if ( !it.formaction ) it.formaction = it.actionurl; 
  }

  pass = true; 

} catch(Throwable t) {
  def errmsg = t.message; 
  if ( !errmsg ) {
    def cause = t.cause; 
    while ( cause != null ) {
      errmsg = cause.message; 
      if ( errmsg ) break; 
    }
  }

  m.errmsg = errmsg; 
  t.printStackTrace();   
}

def escapeHtml = { o-> 
  if ( o ) {
    return org.apache.commons.lang.StringEscapeUtils.escapeHtml( o.toString() ); 
  } else {
    return o;
  }
}
%>

<% if (!pass) {%>
  <pre style="margin:10px;">${m.errmsg.toString()}</pre>

<% } else { %> 

<script>
var paySvc = Service.lookup('FilipizenPaymentService'); 

\$put('paymodel', new function(){

  this.formname = null; 
  this.entity = { agree: false }

  this.submit = function() {
    if ( !this.entity.agree ) {
       alert("You must accept the Terms and Conditions before you submit"); 
       return; 
    }

    var o = paySvc.verifyPaymentOrder({ paymentrefid: '${m.paymentrefid}', silent: true });  
    window.console.log( o ); 
    if ( !o || !o.paymentrefid ) {
      alert('Payment Order transaction is expired or no longer available'); 
      \$('#cancelform').submit();      
    } else {
      \$('#'+this.formname).submit(); 
    }
  }

  this.cancelPayment = function() {
      var r = confirm("You are about to cancel this transaction. Continue?");
      if ( r ) {  
         paySvc.cancelPayment({ paymentrefid: '${m.paymentrefid}'}); 
         \$('#cancelform').submit(); 
      } 
  }

}); 
</script>

 
    <div class="row">
      <div class="col-md-6 col-xs-9">
            <form action="#" method="post" id="paymentOption">
                <div class="row">
                  <label class="col-md-3 col-xs-5 "><STRONG>Control No</STRONG><span class="pull-right">:</span></label>
                  <div class="col-sm-8 nopadleft">
                      ${m.po.controlno}
                  </div>
                </div>
                <div class="row">
                  <label class="col-md-3 col-xs-5  "><STRONG>Particulars</STRONG> <span class="pull-right">:</span></label>
                  <div class="col-sm-8 nopadleft">
                     ${m.po.particulars}
                  </div>
                </div>
                <div class="row">
                  <label class="col-md-3 col-xs-5  "><STRONG>Paidby</STRONG> <span class="pull-right">:</span></label>
                  <div class="col-sm-8 nopadleft">
                    ${escapeHtml(m.po.paidby)}
                  </div>
                </div>
            </form>
      </div>
      <div class="col-md-3 col-xs-3 ">
        <a href="/paymentorder?paymentrefid=${m.po?.paymentrefid}">
          <img src="/res/partners/qrcode.png">
        </a>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8">
        <div class="bankOption">
            <div class="row">
              <label class="col-md-3 col-xs-6 "><STRONG>Amount </STRONG><span class="pull-right">:</span></label>
              <div class="col-md-3 text-right">
                  ${m.amountstr}
              </div>
            </div>
            <div class="row">
              <label class="col-md-3 col-xs-6  "><STRONG>Web Service Fee </STRONG> <span class="pull-right">:</span></label>
              <div class="col-md-3 text-right">
                ${m.webfeestr}
              </div>
            </div>
            <div class="row">
              <label class="col-md-3 col-xs-6  "><STRONG>Total</STRONG><span class="pull-right">:</span></label>
              <div class="col-md-3 text-right">
                <STRONG>${m.totalstr}</STRONG> 
              </div>
            </div>
            <!-- 
            <div class="row">
              <div class="col-sm-12">
                <i>Pay on or before &nbsp; ${m.expirydatestr ? m.expirydatestr : ""}</i>
              </div>
            </div> 
            --> 
        </div>
      </div>
    </div>
    <br>
    <div class="row">
      <div class="col-md-12">
        <label>
          <input type="checkbox" name="checkbox" r:context="paymodel" r:name="entity.agree"/> 
          &nbsp; I acknowledge and agree to the <a href="#" class="terms">Terms and Conditions</a> of this e-payment facility.
        </label>
      </div>
    </div>

    <br/> 
      <div class="row">
        <div class="col-md-12">
          <p style="    padding: 20px 0;font-size: 20px;"><STRONG>Click a payment partner</STRONG></p>
          <div class="row">
            <% m.options.each { o-> %>
              <form id="${o.formname}" method="POST" action="${o.formaction}" style="display:none;">
                <% o.params.each { k,v-> %>
                <input type="hidden" name="$k" value="$v"/>
                <%}%>
              </form>
                <div class="col-md-2 col-xs-6">
                <button class="btn btn-bank-${o.objid.toLowerCase()}" r:context="paymodel" r:name="submit" r:param_formname="${o.formname}">
                   <img src="/res/partners/${o.icon}" >
                </button>
              </div>
            <% } %> 
            <div class="col-md-2 col-xs-6">
                <form id="cancelform" method="POST" action="${PARAMS.cancelurl}"></form>
                      <button r:context="paymodel" r:name="cancelPayment" class="btn btn-bank-cancel"> <img src="/res/partners/cancel.png"> </button> 
              </div>
          </div>
        </div>
      </div>
    
 
    <br/> 
    


<% } %> 
