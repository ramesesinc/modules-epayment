<% 
PARAMS.debug = true; 

def data = null;  
def error = null;
def receipt = null; 
def receiptno = null; 
boolean success = false; 
try {
    receiptno = PARAMS.receiptno; 
    if ( !receiptno ) receiptno = REQUEST.queryString.toString().split('&')[0];

    if ( receiptno ) { 
        def svc = SERVICE.lookup("FilipizenPaymentService"); 
        data = svc.getReceipt([ receiptno: receiptno ]); 
        receipt = data?.info;  
    } 

    if ( !receipt ) 
        throw new Exception('receipt not found'); 

    if ( receipt.amount ) {
        def svc = SERVICE.lookup('NumberService'); 
        receipt.amountinwords = svc.doubleToWords( receipt.amount ).toUpperCase() + ' ONLY'; 
    } 

    receipt.txndatestr = receipt.receiptdate.toString(); 
    if ( receipt.receiptdate instanceof java.util.Date ) {
        def ymd = new java.text.SimpleDateFormat('MMM dd, yyyy'); 
        receipt.txndatestr = ymd.format( receipt.receiptdate ); 
    } 

    success = true; 

} catch(Throwable t) { 
    error = t; 
    data = [:]; 
    receipt = [:]; 
    t.printStackTrace();
}

def serverhost = PROJECT.get('server.host'); 
if ( !serverhost ) serverhost = 'www.filipizen.com';

def qrdata = 'http://'+ serverhost +'/receipt?'+ receiptno;  
def decformat = new java.text.DecimalFormat('#,##0.00'); 

def escapeHtml = { o-> 
  if ( o ) {
    return org.apache.commons.lang.StringEscapeUtils.escapeHtml( o.toString() ); 
  } else {
    return o;
  }
}
%> 

<div class="container" id="content">
    <div class="row color-invoice">
    <% if ( !success ) { %> 
        <h2> Receipt number does not exist. Please check </h2> 
    <% } %> 

    <% if ( success ) { %> 

        <div class="col-md-12">
            <div class="row">
                <div class="receiptinfo col-md-7">
                    EOR No.: 
                    <h1 class="eorno">${receipt.receiptno}</h1>
                    <strong>Paid By : </strong> ${escapeHtml(receipt.paidby)}
                    <br />
                    <strong>Address: </strong> ${escapeHtml(receipt.paidbyaddress)}
                    <br />
                    <strong>Particulars: </strong> ${escapeHtml(data.particulars)}
                </div>
                <div class="qrdata col-md-5">
                    <div id="output"></div>
                </div>
            </div>
      
            <hr>
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <strong>PAYMENT DETAILS :</strong>
                </div>
            </div>

            <hr>
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th class="text-left" style="padding-left:15px;">Account</th>
                                <th class="text-right" style="padding-right:15px;" maxWidth="100">Amount</th>
                            </tr>
                            </thead>
                            <tbody>
                            <% receipt.items?.each{ o-> %> 
                            <tr> 
                                <td class="text-left" style="padding-left:15px;"> ${o.item?.title} ${o.remarks ? (' ( '+ o.remarks +' ) ') : ''} </td> 
                                <td class="text-right" style="padding-right:15px;"> ${o.amount ? decformat.format(o.amount) : null } </td> 
                            </tr> 
                            <% } %> 
                            </tbody>
                        </table>
                    </div>
                    
                    <hr>
                    <div>
                        <h4>  TOTAL : Php ${receipt.amount ? decformat.format(receipt.amount) : null } </h4>
                    </div>

                    <hr>
                    <div>
                        <h4>  Amount in words : ${receipt.amountinwords} </h4>
                    </div>

                    <hr>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <strong>Bank : </strong> ${data.partner?.name}
                    <br />
                    <strong>Txn No.: </strong> ${data.traceid} 
                    <br />
                    <strong>Txn Date: </strong> ${receipt.txndatestr}
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <button onclick="location.href='javascript:window.print()';" href="" class="btn btn-primary btn-sm btn-eor" >Print EOR</button> &nbsp; &nbsp; &nbsp;
                    <!-- <button id="export" class="btn btn-info btn-sm btn-eor">Download In Pdf</button> -->
                </div>
            </div>
            <hr class="hr-bottom">
        </div>
    <% } %>  
    </div>
</div>


<script type="text/javascript">

jQuery(function(){
    jQuery('#output').qrcode({ 
    width: 148,
    height: 148,
    text: "${qrdata}"});
})

document.getElementById('export').addEventListener('click',
  exportPDF);

var specialElementHandlers = {
  // element with id of "bypass" - jQuery style selector
  '.no-export': function(element, renderer) {
    // true = "handled elsewhere, bypass text extraction"
    return true;
  }
};

function exportPDF() {

  var doc = new jsPDF('p', 'pt', 'a4');
  //A4 - 595x842 pts
  //https://www.gnu.org/software/gv/manual/html_node/Paper-Keywords-and-paper-size-in-points.html


  //Html source 
  var source = document.getElementById('content').innerHTML;

  var margins = {
    top: 30,
    bottom: 10,
    left: 10,
    width: 895
  };

  doc.fromHTML(
    source, // HTML string or DOM elem ref.
    margins.left,
    margins.top, {
      'width': margins.width,
      'elementHandlers': specialElementHandlers
    },

    function(dispose) {
      // dispose: object with X, Y of the last line add to the PDF 
      //          this allow the insertion of new lines after html
      doc.save('${receipt.receiptno}.pdf');
    }, margins);
}

</script>
